name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 2.0.1)'
        required: true
      tag:
        description: 'NPM tag (latest, beta, next)'
        required: true
        default: 'latest'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Build all packages
      run: |
        npm run build
        npm run build:packages
    
    - name: Test
      run: npm test
    
    - name: Configure npm
      run: |
        echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Publish packages
      run: |
        # Publish core first
        npm publish --access public
        
        # Then publish other packages
        for package in packages/*; do
          if [ -f "$package/package.json" ]; then
            echo "Publishing $package..."
            (cd "$package" && npm publish --access public) || echo "Skipping $package"
          fi
        done
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}